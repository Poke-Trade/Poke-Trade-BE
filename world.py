from room import Room
from player import Player
from grid import Grid
import random
import math
import bcrypt


class World:
    def __init__(self):
        self.starting_room = None
        self.rooms = {}
        self.players = {}
        self.create_world()
        self.password_salt = bcrypt.gensalt()

    def add_player(self, username, password1, password2):
        if password1 != password2:
            return {'error': "Passwords do not match"}
        elif len(username) <= 2:
            return {'error': "Username must be longer than 2 characters"}
        elif len(password1) <= 5:
            return {'error': "Password must be longer than 5 characters"}
        elif self.get_player_by_username(username) is not None:
            return {'error': "Username already exists"}
        password_hash = bcrypt.hashpw(password1.encode(), self.password_salt)
        player = Player(username, self.starting_room, password_hash)
        self.players[player.auth_key] = player
        return {'key': player.auth_key}

    def get_player_by_auth(self, auth_key):
        if auth_key in self.players:
            return self.players[auth_key]
        else:
            return None

    def get_player_by_username(self, username):
        for auth_key in self.players:
            if self.players[auth_key].username == username:
                return self.players[auth_key]
        return None

    def authenticate_user(self, username, password):
        user = self.get_player_by_username(username)
        if user is None:
            return None
        password_hash = bcrypt.hashpw(password.encode(), self.password_salt)
        if user.password_hash == password_hash:
            return user
        return None

    # UNDERSTAND
    #   Build a grid filled up by rooms
    #   Need to have a perimeter and a be be able to hold 100 rooms

    def create_world(self):
        # Generate 100 rooms in a 10x10 grid style
        # generate them first, then connect them all together
        grid_map = Grid(100)
        grid_map.create_grid(10, 10, 100)
        self.rooms = grid_map.rooms

